# JSON Schema Documentation

This document describes the JSON file formats used by the sonoPleth spatial audio renderer.

## LUSID Scene JSON (`scene.lusid.json`) — Primary Format

As of v0.5.1, the **LUSID scene** is the canonical spatial data format read directly by the C++ renderer. For full documentation see `LUSID/internalDocs/DEVELOPMENT.md` and `LUSID/schema/lusid_scene_v0.5.schema.json`.

### Schema (abbreviated)

```json
{
  "version": "0.5",
  "sampleRate": 48000,
  "timeUnit": "seconds",
  "metadata": { "sourceFormat": "ADM", "duration": "00:09:26.000" },
  "frames": [
    {
      "time": 0.0,
      "nodes": [
        {
          "id": "1.1",
          "type": "direct_speaker",
          "cart": [-1.0, 1.0, 0.0],
          "speakerLabel": "RC_L",
          "channelID": "AC_00011001"
        },
        { "id": "4.1", "type": "LFE" },
        { "id": "11.1", "type": "audio_object", "cart": [0.0, 1.0, 0.0] }
      ]
    },
    {
      "time": 0.5,
      "nodes": [
        { "id": "11.1", "type": "audio_object", "cart": [0.3, 0.9, 0.1] }
      ]
    }
  ]
}
```

### Node Types

| Type                | ID Pattern          | Description                                              |
| ------------------- | ------------------- | -------------------------------------------------------- |
| `direct_speaker`    | `X.1` (groups 1–10) | Fixed bed channel with position, speakerLabel, channelID |
| `audio_object`      | `X.1` (groups 11+)  | Time-varying spatial source                              |
| `LFE`               | `X.1`               | Low-frequency effects — not spatialized                  |
| `spectral_features` | `X.2+`              | Analysis metadata (ignored by renderer)                  |
| `agent_state`       | `X.2+`              | AI metadata (ignored by renderer)                        |

### Source ↔ WAV File Mapping

| Node ID | WAV Filename | Notes                |
| ------- | ------------ | -------------------- |
| `1.1`   | `1.1.wav`    | DirectSpeaker        |
| `4.1`   | `LFE.wav`    | LFE (special naming) |
| `11.1`  | `11.1.wav`   | Audio object         |

---

## ~~Spatial Instructions JSON (`renderInstructions.json`)~~ — DEPRECATED

> **Deprecated as of v0.5.1.** The old `renderInstructions.json` format is no longer generated by the pipeline. The C++ renderer now reads `scene.lusid.json` directly. The old format is preserved in `src/packageADM/old_schema/createRenderInfo.py` for reference.

### Old Schema (for reference)

```json
{
  "sampleRate": 48000,
  "timeUnit": "seconds",
  "sources": {
    "src_1": [
      { "time": 0.0, "cart": [x, y, z] },
      { "time": 1.5, "cart": [x, y, z] }
    ],
    "src_2": [...]
  }
}
```

---

## Speaker Layout JSON (`allosphere_layout.json`)

This file defines the speaker positions for the target playback system.

### Schema

```json
{
  "speakers": [
    {
      "azimuth": 0.0,
      "elevation": 0.0,
      "radius": 5.0,
      "deviceChannel": 1
    }
  ]
}
```

### Fields

| Field      | Type  | Description                  |
| ---------- | ----- | ---------------------------- |
| `speakers` | array | Array of speaker definitions |

### Speaker Definition

| Field           | Type    | Unit        | Description                                                     |
| --------------- | ------- | ----------- | --------------------------------------------------------------- |
| `azimuth`       | number  | **radians** | Horizontal angle (0 = front, positive = right)                  |
| `elevation`     | number  | **radians** | Vertical angle (0 = horizon, positive = up)                     |
| `radius`        | number  | meters      | Distance from center (typically 5.0 for AlloSphere)             |
| `deviceChannel` | integer | -           | Hardware channel number (informational, not used for rendering) |

**Note:** The renderer uses consecutive channel indices (0, 1, 2, ...) regardless of `deviceChannel` values. Channel remapping to hardware channels should be done during playback.

---

## Validation

The renderer performs the following validation:

1. **Keyframe validation**: Drops keyframes with NaN/Inf values
2. **Zero vector handling**: Replaces zero-length direction vectors with front (0, 1, 0)
3. **Time sorting**: Sorts keyframes by time ascending
4. **Duplicate removal**: Collapses keyframes with identical timestamps
5. **Time unit detection**: Falls back to heuristic if `timeUnit` not specified (with warning)

---

## Best Practices

1. **Always specify `timeUnit`** - Don't rely on heuristic detection
2. **Use seconds** when possible - Most intuitive and least error-prone
3. **Normalize direction vectors** - While the renderer normalizes them, pre-normalized vectors are cleaner
4. **Match sample rates** - Ensure `sampleRate` matches your audio files
5. **Source naming** - WAV files use LUSID node ID naming: `X.1.wav` (e.g., `1.1.wav`, `11.1.wav`), LFE stays `LFE.wav`
